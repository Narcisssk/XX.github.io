<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>NeuSym-RAG Task Explorer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.3/css/bulma.min.css">
    <link rel="stylesheet" href="./static/css/explorer.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>

    <style>
        .is-halfheight {
            height: 50vh;
            overflow-y: scroll;
        }

        .category {
            background-color: #eee;
            color: #444;
            cursor: pointer;
            padding: 10px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 15px;
            transition: 0.4s;
        }

        .task-list {
            border: none;
        }

        .task-list:hover {
            background-color: #f2f0f0;
        }

        .active,
        .category:hover {
            background-color: #ccc;
        }

        .task-active {
            background-color: #f3f0f0;
        }

        .category:after {
            content: "\002B";
            color: #000000;
            font-weight: bold;
            float: right;
            margin-left: 5px;
        }

        .active:after {
            content: "\2212";
        }

        .panel {
            padding: 0 18px;
            background-color: white;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
        }

        .categorycontainer {
            max-height: 180vh;
            overflow-y: scroll;
        }

        .taskid-container {
            display: flex;
            align-items: center;
        }

        .taskid-label {
            margin-left: 10px;
            padding: 5px 10px;
            background-color: #f2f2f2;
            border-radius: 4px;
            font-size: 1rem;
        }

        .highlight-quote {
            background-color: #f9f9f9;
            border-left: 4px solid #007BFF;
            padding: 10px 15px;
            margin: 15px 0;
            color: #333;
        }

        .highlight-quote-title {
            font-weight: bold;
            margin-top: 0;
            margin-bottom: 10px;
            color: #007BFF;
        }

        .highlight-quote-content {
            font-style: italic;
            max-height: 180px;
            overflow: auto;
        }

        .tag-container {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .tag-group {
            margin-bottom: 15px;
        }
        .tag-group-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .tag-button {
            margin: 2px;
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 15px;
            background: #f5f5f5;
            cursor: pointer;
        }
        .tag-button.selected {
            background: #3273dc;
            color: white;
        }
        .trajectory-turn {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .turn-header {
            font-weight: bold;
            color: #3273dc;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #3273dc;
        }
        .turn-content {
            margin-left: 15px;
        }
        .status-tag {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            margin: 5px;
        }
        .status-tag.correct {
            background-color: #48c774;
            color: white;
        }
        .status-tag.incorrect {
            background-color: #f14668;
            color: white;
        }
        .task-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            margin: 2px;
            font-size: 0.9em;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
        }
        .task-tag.task-type {
            background-color: #3273dc;
            color: white;
        }
        .task-tag.content-type {
            background-color: #00d1b2;
            color: white;
        }
        .task-tag.question-type {
            background-color: #ffdd57;
            color: #363636;
        }
        .highlight-quote {
            background-color: #f9f9f9;
            border-left: 4px solid #007BFF;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .task-id-display {
            font-family: monospace;
            background-color: #f5f5f5;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
    </style>
</head>

<body>
    <script type="module" src="https://md-block.verou.me/md-block.js"></script>

    <section class="section is-max-desktop">
        <div class="container">
            <h2 class="title is-3" style="display: inline-block; vertical-align: middle;">NeuSym-RAG Task Explorer</h2>
            <div class="notification is-info">
                <md-block>
                    Below we show a subset of NeuSym-RAG tasks, which allows you to explore the tasks in detail.<br>
                    Tasks are categorized as either correct or incorrect based on their evaluation results.
                </md-block>
            </div>
        </div>
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Load task data
            Promise.all([
                fetch('./static/data/task_viewer/correct/task_ids.json').then(response => response.json()),
                fetch('./static/data/task_viewer/incorrect/task_ids.json').then(response => response.json())
            ]).then(([correctTasks, incorrectTasks]) => {
                const container = document.getElementById('categoriesContainer');
                
                // Create categories
                const categories = {
                    'Correct Tasks': correctTasks,
                    'Incorrect Tasks': incorrectTasks
                };

                Object.entries(categories).forEach(([category, tasks]) => {
                    // Create category button
                    const catButton = document.createElement('button');
                    catButton.textContent = category;
                    catButton.classList.add('category');
                    container.appendChild(catButton);

                    // Create task list
                    const taskList = document.createElement('ul');
                    taskList.classList.add('panel');
                    
                    tasks.forEach((taskId, index) => {
                        const listItem = document.createElement('li');
                        listItem.classList.add('task-list');
                        listItem.textContent = `Task ${index + 1}`;

                        listItem.addEventListener('click', () => {
                            // Load task data
                            Promise.all([
                                fetch(`./static/data/task_viewer/questions/${taskId}.json`).then(response => response.json()),
                                fetch(`./static/data/task_viewer/${category.toLowerCase().includes('correct') ? 'correct' : 'incorrect'}/${taskId}.jsonl`)
                                    .then(response => response.text())
                                    .then(text => {
                                        // Parse JSONL file
                                        const lines = text.trim().split('\n');
                                        return lines.map(line => JSON.parse(line));
                                    })
                            ]).then(([taskData, trajectory]) => {
                                // Update UI
                                document.getElementById('taskid-text').textContent = taskId;
                                document.getElementById('question-text').textContent = taskData.question;
                                
                                // Update status
                                const statusFlag = document.getElementById('status-flag');
                                statusFlag.innerHTML = `<b>Status:</b> <span class="tag-${category.toLowerCase().includes('correct') ? 'success' : 'failure'}">${category.toLowerCase().includes('correct') ? 'success' : 'failure'}</span>`;
                                
                                // Update tags
                                const tagList = document.getElementById('tag-list');
                                tagList.innerHTML = '<b>Tags:</b> ' + taskData.tags.map(tag => 
                                    `<span class="tag-${tag.toLowerCase()}">${tag}</span>`
                                ).join(' ');
                                
                                // Update trajectory
                                const formattedTrajectory = trajectory.map((step, index) => {
                                    return `## Step ${index + 1}\n${JSON.stringify(step, null, 2)}`;
                                }).join('\n\n');
                                document.getElementById('trajectory-text').textContent = formattedTrajectory;
                                
                                // Highlight active task
                                document.querySelectorAll('.task-list').forEach(item => item.classList.remove('task-active'));
                                listItem.classList.add('task-active');
                            });
                        });

                        taskList.appendChild(listItem);
                    });

                    container.appendChild(taskList);

                    // Toggle category
                    catButton.addEventListener('click', () => {
                        catButton.classList.toggle('active');
                        if (taskList.style.maxHeight) {
                            taskList.style.maxHeight = null;
                        } else {
                            taskList.style.maxHeight = taskList.scrollHeight + "px";
                        }
                    });
                });
            });
        });
    </script>

    <section class="section">
        <div class="container">
            <h1 class="title">NeuSym-RAG Task Explorer</h1>
            
            <!-- Filter Section -->
            <div class="box">
                
                <!-- Task Type -->
                <div class="tag-group">
                    <div class="tag-group-title">Task Type:</div>
                    <div class="buttons">
                        <button class="button tag-button" data-type="task" data-value="single">Single</button>
                        <button class="button tag-button" data-type="task" data-value="multiple">Multiple</button>
                        <button class="button tag-button" data-type="task" data-value="retrieval">Retrieval</button>
                    </div>
                </div>

                <!-- Task Categories -->
                <div class="tag-group">
                    <div class="tag-group-title">Task Categories:</div>
                    <div class="buttons">
                        <button class="button tag-button" data-type="content" data-value="text">Text</button>
                        <button class="button tag-button" data-type="content" data-value="table">Table</button>
                        <button class="button tag-button" data-type="content" data-value="image">Image</button>
                        <button class="button tag-button" data-type="content" data-value="formula">Formula</button>
                        <button class="button tag-button" data-type="content" data-value="metadata">Metadata</button>
                    </div>
                </div>

                <!-- Evaluation Genre -->
                <div class="tag-group">
                    <div class="tag-group-title">Evaluation Genre:</div>
                    <div class="buttons">
                        <button class="button tag-button" data-type="question" data-value="subjective">Subjective</button>
                        <button class="button tag-button" data-type="question" data-value="objective">Objective</button>
                    </div>
                </div>

                <button id="filterButton" class="button is-primary">Filter Tasks</button>
                <button id="randomButton" class="button is-info">Show a Random Task</button>
            </div>

            <!-- Results Section -->
            <div class="box" id="resultsSection" style="display: none;">
                <h2 class="subtitle">Task Details</h2>
                <div class="content">
                    <div class="field is-grouped is-grouped-multiline">
                        <div class="control">
                            <div class="tags has-addons">
                                <span class="tag is-dark">Task ID</span>
                                <span class="tag is-info task-id-display" id="taskId"></span>
                            </div>
                        </div>
                        <div class="control">
                            <div class="tags has-addons">
                                <span class="tag is-dark">Status</span>
                                <span class="tag" id="taskStatus"></span>
                            </div>
                        </div>
                    </div>

                    <div class="tags" id="taskTags"></div>
                    
                    <div class="highlight-quote">
                        <p class="has-text-weight-bold">Question:</p>
                        <p id="taskQuestion"></p>
                    </div>

                    <div class="highlight-quote">
                        <p class="has-text-weight-bold">Trajectory:</p>
                        <div id="taskTrajectory"></div>
                    </div>
                </div>
            </div>

            <!-- No Match Section -->
            <div class="box" id="noMatchSection" style="display: none;">
                <div class="notification is-warning">
                    <p class="has-text-weight-bold">No matching tasks found</p>
                    <p>There are no tasks in the current subset that match the selected filters:</p>
                    <div class="content">
                        <ul id="selectedFiltersList"></ul>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        let allTasks = [];
        let selectedFilters = {
            task: new Set(),
            content: new Set(),
            question: new Set()
        };

        // Load all tasks
        async function loadTasks() {
            try {
                // First get the list of all task IDs
                const response = await fetch('./static/data/task_viewer/questions/task_ids.json');
                const taskIds = await response.json();
                
                // Then load each task's data
                const taskPromises = taskIds.map(async (taskId) => {
                    const taskResponse = await fetch(`./static/data/task_viewer/questions/${taskId}.json`);
                    return taskResponse.json();
                });
                
                allTasks = await Promise.all(taskPromises);
            } catch (error) {
                console.error('Error loading tasks:', error);
            }
        }

        // Initialize tag buttons
        function initializeTagButtons() {
            document.querySelectorAll('.tag-button').forEach(button => {
                button.addEventListener('click', () => {
                    const type = button.dataset.type;
                    const value = button.dataset.value;
                    
                    // Handle different selection rules for different tag types
                    if (type === 'task' || type === 'question') {
                        // For task type and question type, only one can be selected
                        if (button.classList.contains('selected')) {
                            button.classList.remove('selected');
                            selectedFilters[type].delete(value);
                        } else {
                            // Deselect other buttons in the same group
                            document.querySelectorAll(`.tag-button[data-type="${type}"]`).forEach(btn => {
                                btn.classList.remove('selected');
                                selectedFilters[type].delete(btn.dataset.value);
                            });
                            // Select the clicked button
                            button.classList.add('selected');
                            selectedFilters[type].add(value);
                        }
                    } else {
                        // For content type, multiple selections are allowed
                        if (button.classList.contains('selected')) {
                            button.classList.remove('selected');
                            selectedFilters[type].delete(value);
                        } else {
                            button.classList.add('selected');
                            selectedFilters[type].add(value);
                        }
                    }
                });
            });
        }

        // Filter tasks based on selected tags
        function filterTasks() {
            return allTasks.filter(task => {
                const taskTags = new Set(task.tags);
                
                // Check task type (must match exactly)
                if (selectedFilters.task.size > 0) {
                    const hasTaskType = Array.from(selectedFilters.task).some(type => taskTags.has(type));
                    if (!hasTaskType) return false;
                }

                // Check content type (must match all selected)
                if (selectedFilters.content.size > 0) {
                    const hasAllContentTypes = Array.from(selectedFilters.content).every(type => taskTags.has(type));
                    if (!hasAllContentTypes) return false;
                }

                // Check question type (must match exactly)
                if (selectedFilters.question.size > 0) {
                    const hasQuestionType = Array.from(selectedFilters.question).some(type => taskTags.has(type));
                    if (!hasQuestionType) return false;
                }

                return true;
            });
        }

        // Load and display trajectory
        async function loadTrajectory(taskId) {
            try {
                const response = await fetch(`./static/data/task_viewer/trajectory/${taskId}.jsonl`);
                const text = await response.text();
                const lines = text.trim().split('\n');
                
                // Skip the first two lines (environment prompts)
                const steps = lines.slice(2).map(line => JSON.parse(line));
                
                // Group steps into turns (every two steps)
                const turns = [];
                for (let i = 0; i < steps.length; i += 2) {
                    if (i + 1 < steps.length) {
                        turns.push([steps[i], steps[i + 1]]);
                    }
                }
                
                const trajectoryDiv = document.getElementById('taskTrajectory');
                trajectoryDiv.innerHTML = turns.map((turn, index) => `
                    <div class="trajectory-turn">
                        <div class="turn-header">Turn ${index + 1}</div>
                        <div class="turn-content">
                            <div class="mb-3">
                                <strong>Thought and Action:</strong>
                                <pre><code class="language-json">${JSON.stringify(turn[0], null, 2)}</code></pre>
                            </div>
                            <div>
                                <strong>Observation:</strong>
                                <pre><code class="language-json">${JSON.stringify(turn[1], null, 2)}</code></pre>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // Apply syntax highlighting
                Prism.highlightAll();
            } catch (error) {
                console.error('Error loading trajectory:', error);
                document.getElementById('taskTrajectory').innerHTML = 'No trajectory data available';
            }
        }

        // Display task details
        async function displayTask(task) {
            document.getElementById('taskId').textContent = task.uuid;
            
            // Update status with styled tag
            const statusTag = document.getElementById('taskStatus');
            statusTag.textContent = task.status;
            statusTag.className = `tag status-tag ${task.status.toLowerCase()}`;
            
            // Update tags with styled tags
            const tagList = document.getElementById('taskTags');
            tagList.innerHTML = task.tags.map(tag => {
                let tagClass = 'task-tag';
                if (['single', 'multiple', 'retrieval'].includes(tag)) {
                    tagClass += ' task-type';
                } else if (['text', 'table', 'image', 'formula', 'metadata'].includes(tag)) {
                    tagClass += ' content-type';
                } else if (['subjective', 'objective'].includes(tag)) {
                    tagClass += ' question-type';
                }
                return `<span class="${tagClass}">${tag}</span>`;
            }).join('');
            
            document.getElementById('taskQuestion').textContent = task.question;
            
            await loadTrajectory(task.uuid);
            
            document.getElementById('resultsSection').style.display = 'block';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadTasks();
            initializeTagButtons();

            // Filter button click handler
            document.getElementById('filterButton').addEventListener('click', () => {
                const filteredTasks = filterTasks();
                if (filteredTasks.length > 0) {
                    document.getElementById('noMatchSection').style.display = 'none';
                    document.getElementById('resultsSection').style.display = 'block';
                    const randomTask = filteredTasks[Math.floor(Math.random() * filteredTasks.length)];
                    displayTask(randomTask);
                } else {
                    // Show no match message in a card
                    document.getElementById('resultsSection').style.display = 'none';
                    const noMatchSection = document.getElementById('noMatchSection');
                    noMatchSection.style.display = 'block';
                    
                    // Update the list of selected filters
                    const selectedTypes = {
                        task: Array.from(selectedFilters.task),
                        content: Array.from(selectedFilters.content),
                        question: Array.from(selectedFilters.question)
                    };
                    
                    const filtersList = document.getElementById('selectedFiltersList');
                    filtersList.innerHTML = '';
                    
                    if (selectedTypes.task.length > 0) {
                        const li = document.createElement('li');
                        li.textContent = `Task Type: ${selectedTypes.task.join(', ')}`;
                        filtersList.appendChild(li);
                    }
                    if (selectedTypes.content.length > 0) {
                        const li = document.createElement('li');
                        li.textContent = `Task Categories: ${selectedTypes.content.join(', ')}`;
                        filtersList.appendChild(li);
                    }
                    if (selectedTypes.question.length > 0) {
                        const li = document.createElement('li');
                        li.textContent = `Evaluation Genre: ${selectedTypes.question.join(', ')}`;
                        filtersList.appendChild(li);
                    }
                }
            });

            // Random button click handler
            document.getElementById('randomButton').addEventListener('click', () => {
                document.getElementById('noMatchSection').style.display = 'none';
                document.getElementById('resultsSection').style.display = 'block';
                const randomTask = allTasks[Math.floor(Math.random() * allTasks.length)];
                displayTask(randomTask);
            });
        });
    </script>
</body>

</html>
